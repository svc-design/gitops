---
- name: "S3FS | 检查 s3fs 配置"
  fail:
    msg: "S3FS 需要配置 s3fs_config.bucket 和 s3fs_config.mount_point"
  when:
    - s3fs_config.bucket | length == 0
    - s3fs_config.mount_point | length == 0

- name: "S3FS | 检查 AWS 凭证"
  fail:
    msg: "S3FS 需要配置 s3fs_config.access_key 和 s3fs_config.secret_key"
  when:
    - s3fs_config.access_key | length == 0
    - s3fs_config.secret_key | length == 0

- name: "S3FS | 安装 s3fs 软件包"
  apt:
    name: s3fs
    state: present
  become: yes
  when: ansible_facts.os_family == 'Debian'

- name: "S3FS | 安装 s3fs 软件包 (CentOS/RHEL)"
  yum:
    name: s3fs-fuse
    state: present
  become: yes
  when: ansible_facts.os_family == 'RedHat'

- name: "S3FS | 创建密码文件"
  copy:
    content: "{{ s3fs_config.access_key }}:{{ s3fs_config.secret_key }}"
    dest: "{{ s3fs_config.passwd_file | expanduser }}"
    mode: '0600'
    owner: root
    group: root
  when: s3fs_config.access_key | length > 0 and s3fs_config.secret_key | length > 0

- name: "S3FS | 创建挂载点目录"
  file:
    path: "{{ s3fs_config.mount_point }}"
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: "S3FS | 检查是否已挂载"
  shell: "mount | grep -q '{{ s3fs_config.mount_point }}' && echo 'mounted' || echo 'not mounted'"
  register: s3fs_mount_check
  changed_when: false
  failed_when: false

- name: "S3FS | 挂载 S3 存储桶"
  command: >
    s3fs {{ s3fs_config.bucket }} {{ s3fs_config.mount_point }}
    -o passwd_file={{ s3fs_config.passwd_file | expanduser }}
    {% if s3fs_config.allow_other %}-o allow_other{% endif %}
    -o url={{ s3fs_config.url }}
    {% if s3fs_config.use_path_request_style %}-o use_path_request_style{% endif %}
  args:
    creates: "{{ s3fs_config.mount_point }}/.s3fs_configured"
  when: s3fs_mount_check.stdout == 'not mounted'

- name: "S3FS | 创建挂载标记文件"
  copy:
    content: "S3FS mounted at {{ ansible_date_time.iso8601 }}"
    dest: "{{ s3fs_config.mount_point }}/.s3fs_configured"
    mode: '0644'
    owner: root
    group: root
  when: s3fs_mount_check.stdout == 'not mounted'

- name: "S3FS | 验证挂载"
  shell: "mount | grep '{{ s3fs_config.mount_point }}'"
  register: s3fs_verify_mount
  changed_when: false
  failed_when: true

- name: "S3FS | 显示挂载信息"
  debug:
    msg: |
      S3 存储桶已成功挂载！
      存储桶: {{ s3fs_config.bucket }}
      挂载点: {{ s3fs_config.mount_point }}
      状态: {{ s3fs_verify_mount.stdout }}
